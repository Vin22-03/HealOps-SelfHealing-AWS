pipeline {
  agent any

  environment {
    AWS_DEFAULT_REGION = "us-east-1"
    TF_WORKING_DIR     = "infra/terraform"
  }

  options {
    disableConcurrentBuilds()
  }

  stages {

    stage('Checkout Source Code') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[
            url: 'https://github.com/Vin22-03/HealOps-SelfHealing-AWS.git',
            credentialsId: 'githubcreds'
          ]]
        ])
      }
    }

    stage('Terraform Init') {
      steps {
        withCredentials([
          [$class: 'AmazonWebServicesCredentialsBinding',
           credentialsId: 'aws-healops']
        ]) {
          sh """
            cd ${TF_WORKING_DIR}
            terraform init -input=false
          """
        }
      }
    }

    stage('Terraform Format & Validate') {
      steps {
        sh """
          cd ${TF_WORKING_DIR}
          terraform fmt -check
          terraform validate
        """
      }
    }

    stage('Terraform Plan') {
      steps {
        withCredentials([
          [$class: 'AmazonWebServicesCredentialsBinding',
           credentialsId: 'aws-healops']
        ]) {
          sh """
            cd ${TF_WORKING_DIR}
            terraform plan -out=tfplan -input=false
          """
        }
      }
    }
  }

  post {
    success {
      archiveArtifacts artifacts: 'infra/terraform/tfplan', fingerprint: true
      echo "✅ Terraform plan generated & archived successfully for HealOps"
    }

    failure {
      echo "❌ HealOps pipeline failed. Check logs carefully."
    }
  }
}
